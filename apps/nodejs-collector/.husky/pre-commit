#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook for nodejs-collector
echo "üîç Running pre-commit checks for nodejs-collector..."

cd apps/nodejs-collector

# 1. Lint check
echo "üìù Running ESLint..."
npm run lint || {
  echo "‚ùå ESLint failed. Please fix linting errors."
  exit 1
}

# 2. Type check
echo "üîß Running TypeScript type check..."
npm run typecheck || {
  echo "‚ùå TypeScript type check failed."
  exit 1
}

# 3. Run tests
echo "üß™ Running tests..."
npm test || {
  echo "‚ùå Tests failed. Please fix failing tests."
  exit 1
}

# 4. Quick API validation (if server is running)
if lsof -Pi :3001 -sTCP:LISTEN -t >/dev/null ; then
  echo "üåê Running API validation..."
  curl -f http://localhost:3001/health > /dev/null 2>&1 || {
    echo "‚ö†Ô∏è  Warning: API health check failed (non-blocking)"
  }
fi

echo "‚úÖ All pre-commit checks passed!"