name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ë¹„ë°€ ì •ë³´ ìŠ¤ìº”
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê²€ì‚¬ë¥¼ ìœ„í•´

      - name: TruffleHog OSS - ë¹„ë°€ ì •ë³´ ìŠ¤ìº”
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Gitleaks - ì¶”ê°€ ë¹„ë°€ ì •ë³´ ê²€ì‚¬
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Python ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
        uses: pyupio/safety-action@v1
        with:
          api-key: ${{ secrets.SAFETY_API_KEY }}
        continue-on-error: true  # API í‚¤ ì—†ì–´ë„ ê¸°ë³¸ ê²€ì‚¬ ì‹¤í–‰

      - name: Node.js ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
        run: |
          # package-lock.jsonì´ ì—†ìœ¼ë¯€ë¡œ ìˆ˜ë™ ì„¤ì¹˜ í›„ ê²€ì‚¬
          npm install node-fetch@2 dotenv
          npx audit-ci --low
        continue-on-error: true  # ê²½ê³  ìˆ˜ì¤€ì—ì„œëŠ” ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ

  # ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”
  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python
          queries: security-and-quality

      - name: CodeQL ë¶„ì„ ì‹¤í–‰
        uses: github/codeql-action/analyze@v3

  # ì»¤ìŠ¤í…€ ë³´ì•ˆ ì²´í¬
  custom-checks:
    name: Custom Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: API í‚¤ íŒ¨í„´ ê²€ì‚¬
        run: |
          echo "ğŸ” KRA API í‚¤ íŒ¨í„´ ê²€ì‚¬ ì¤‘..."
          
          # API í‚¤ íŒ¨í„´ ê²€ì‚¬ - ì‹¤ì œ í‚¤ ê°’ì´ í•˜ë“œì½”ë”©ëœ ê²½ìš°ë§Œ ê²€ì‚¬
          # ${API_KEY} ê°™ì€ ë³€ìˆ˜ ì°¸ì¡°ëŠ” ì œì™¸
          if grep -r "serviceKey\s*[:=]\s*[\"'][^$\"']*[\"']" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=data --exclude="KRA_PUBLIC_API_GUIDE.md" | grep -v "process\.env\|getenv\|VITE_\|import\.meta\.env\|\${.*}\|API_KEY"; then
            echo "âŒ í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."

      - name: .env íŒŒì¼ ê²€ì‚¬
        run: |
          echo "ğŸ” .env íŒŒì¼ ì»¤ë°‹ ê²€ì‚¬ ì¤‘..."
          
          # .env íŒŒì¼ì´ gitì— ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if git ls-files | grep -E "^\.env$|^\.env\."; then
            echo "âŒ .env íŒŒì¼ì´ ì»¤ë°‹ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… .env íŒŒì¼ì´ ì˜¬ë°”ë¥´ê²Œ ì œì™¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤."

      - name: ë¯¼ê°í•œ ë°ì´í„° ë””ë ‰í„°ë¦¬ ê²€ì‚¬
        run: |
          echo "ğŸ” data/ ë””ë ‰í„°ë¦¬ ê²€ì‚¬ ì¤‘..."
          
          # data/ ë””ë ‰í„°ë¦¬ê°€ gitì— ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if git ls-files | grep "^data/"; then
            echo "âŒ data/ ë””ë ‰í„°ë¦¬ì˜ íŒŒì¼ì´ ì»¤ë°‹ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… data/ ë””ë ‰í„°ë¦¬ê°€ ì˜¬ë°”ë¥´ê²Œ ì œì™¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤."

      - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ğŸ“Š ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
          echo "ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í•˜ë©´ PRì„ ì•ˆì „í•˜ê²Œ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."