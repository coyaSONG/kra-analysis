# 재귀 개선 프로세스 결과 정리

## 프로세스 개요
- **시작일**: 2025-06-07
- **목표**: 삼복연승 예측 프롬프트의 성능을 재귀적으로 개선
- **방법론**: 평가 → 분석 → 개선안 도출 → 재평가 사이클

## 버전별 성능 추이

### v1.0 (초기 버전)
- **특징**: 복잡한 가중치 시스템 (35%/25%/15%/15%/10%)
- **문제점**: 시장 평가 비중 너무 낮음
- **결과**: 테스트 미실행

### v2.0
- **개선사항**: 
  - Chain of Thought 추가
  - XML 태그 구조화
  - 시장 평가 10% → 20%
- **결과**: 
  - 완전 적중: 0%
  - 평균 적중: 1.11/3
  - 1위 인기마 자주 놓침

### v3.0
- **개선사항**:
  - 시장 평가 20% → 40%
  - 인기마 보호 규칙 추가
  - 보수적 선택 전략
- **결과**:
  - 완전 적중: 0%
  - 많은 Execution error 발생

### v3.1 (간소화)
- **개선사항**:
  - 프롬프트 길이 대폭 축소 (1395 → 382자)
  - 특수문자 제거
  - 단순명료한 지시
- **결과**:
  - 완전 적중: 0% → 10% (기권말 필터링 후)
  - 평균 적중: 1.25 → 1.26/3
  - Execution error 대폭 감소

### v4.0
- **개선사항**:
  - 선택 범위 1-5위로 확대
  - 시장 평가 60%로 상향
- **결과**:
  - 대부분 Execution error
  - 코드블록 마크다운이 문제로 추정

### v4.1 (초간단)
- **개선사항**:
  - 극도로 단순화된 지시
  - 배당률만으로 선택
- **결과**:
  - 평균 적중: 0.70/3
  - 여전히 많은 Execution error

## 주요 발견사항

### 1. Execution Error 원인
- **주원인**: 기권/제외 말 (win_odds = 0)
- **해결**: evaluate_prompt.py에 필터링 로직 추가
- **결과**: 오류 대폭 감소 (50% → 18%)

### 2. 프롬프트 최적화
- **길이**: 짧을수록 안정적 (382자가 최적)
- **구조**: 단순명료한 지시가 효과적
- **특수문자**: 가능한 한 제거

### 3. 전략적 인사이트
- **시장 평가 중요성**: 40% 이상 필요
- **인기마 중심**: 1-3위 인기마 위주가 안정적
- **데이터 vs 시장**: 시장의 집단지성이 더 정확

## 최종 권장사항

### 최적 프롬프트 (v3.1-simple)
```markdown
# 경마 예측 v3.1 (간소화)

경마 예측 전문가로서 1-3위 예측하세요.

## 전략
- 배당률 낮은 순 3마리 선택
- 시장평가 40%, 성적 20%, 기수 15%, 조교사 15%, 조건 10%
- 배당률 0인 말 제외

JSON 형식으로 예측 결과 제공
```

### 성능 지표
- **완전 적중률**: 10%
- **평균 적중 말 수**: 1.26/3 (42%)
- **안정성**: Execution error 18% (개선 여지 있음)

## 향후 개선 방향

1. **Execution Error 추가 조사**
   - 남은 18%의 오류 원인 파악
   - 데이터 전처리 강화

2. **하이브리드 접근**
   - 기본: 인기마 중심 (v3.1)
   - 보조: 데이터 분석 (특정 조건에서만)

3. **앙상블 전략**
   - 여러 간단한 프롬프트 조합
   - 투표 방식으로 최종 결정

## 추가 개선 (v5.0 ~ v9.0)

### v5.0 (Robust)
- **개선**: 매우 단순한 지시
- **결과**: 평균 1.40/3, 완전 적중 10%
- **발견**: 데이터 크기 5000자 이상에서 문제 가능성

### v6.0 (Optimal)
- **개선**: 구체적인 JSON 예시 포함 필수
- **결과**: 안정적 작동
- **핵심 발견**: JSON 예시가 없으면 Execution error 발생

### v7.0-v8.0
- **시도**: 전략적 복잡성 증가
- **결과**: 오류 증가
- **교훈**: 복잡할수록 불안정

### v9.0 (Final)
- **개선**: 간단하면서도 전략적
- **결과**: 
  - 평균 적중: 1.32/3 (44%)
  - 완전 적중: 10%
  - 오류율: 18%

## 핵심 발견사항

1. **Execution Error의 진짜 원인**
   - 프롬프트 길이 ❌
   - 구체적 JSON 예시 부재 ✅
   - 막연한 지시는 타임아웃 유발

2. **최적 프롬프트 구조**
   - 간결한 지시
   - 명확한 JSON 예시
   - 1-2위 필수 + 3-5위 중 선택 전략

3. **성능 지표 추이**
   - v1.0: 테스트 안됨
   - v3.1: 1.26/3 (42%)
   - v5.0: 1.40/3 (47%)
   - v9.0: 1.32/3 (44%)

## 최종 권장 프롬프트

```markdown
# 경마 예측 v9.0

배당률 낮은 순 3마리 선택. 단:
- 1-2위는 필수
- 3위는 3-5위 중 하나
- 0은 제외

{"selected_horses": [{"chul_no": 1, "hr_name": "첫째말"}, {"chul_no": 2, "hr_name": "둘째말"}, {"chul_no": 3, "hr_name": "셋째말"}], "confidence": 80, "reasoning": "1-2위+4위"}
```

## 결론

재귀 개선 프로세스를 통해:
1. **JSON 예시의 중요성** 발견
2. **최적 전략**: 1-2위 필수 + 3-5위 중 선택
3. **평균 적중률**: 42% → 44% 개선
4. **안정성**: Execution error 50% → 18% 감소

프롬프트 엔지니어링은 정확성과 안정성의 균형이 핵심임을 확인.