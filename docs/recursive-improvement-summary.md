# 재귀 개선 프로세스 최종 요약

## 프로젝트 개요
- **목표**: 한국마사회(KRA) 경마 삼복연승 예측 프롬프트 최적화
- **기간**: 2025-06-07 ~ 2025-06-08
- **총 버전**: v1.0 ~ v9.0 (9번의 반복 개선)
- **최종 성과**: 평균 적중률 42% → 44%, 완전 적중률 0% → 10%

## 핵심 발견사항

### 1. Execution Error의 진짜 원인
- **초기 가설**: 프롬프트 길이가 문제 (❌)
- **실제 원인 1**: 기권/제외 말 (win_odds = 0) 처리 누락
- **실제 원인 2**: 구체적인 JSON 예시 부재로 인한 타임아웃
- **해결책**: 
  - 기권말 필터링 로직 추가
  - 모든 프롬프트에 JSON 예시 필수 포함

### 2. 최적 프롬프트 구조
```markdown
# 경마 예측 v9.0

배당률 낮은 순 3마리 선택. 단:
- 1-2위는 필수
- 3위는 3-5위 중 하나
- 0은 제외

{"selected_horses": [{"chul_no": 1, "hr_name": "첫째말"}, {"chul_no": 2, "hr_name": "둘째말"}, {"chul_no": 3, "hr_name": "셋째말"}], "confidence": 80, "reasoning": "1-2위+4위"}
```

### 3. 전략적 인사이트
- **시장의 집단지성 우선**: 복잡한 데이터 분석보다 배당률이 더 정확
- **1-2위 인기마 필수**: 완전히 제외하면 성능 급락
- **3위 선택의 유연성**: 3-5위 중 선택이 최적
- **간결함이 핵심**: 복잡한 지시는 오히려 성능 저하

## 버전별 주요 개선사항

| 버전 | 개선 내용 | 결과 |
|------|----------|------|
| v1.0 | 초기 복잡한 가중치 시스템 | 테스트 안됨 |
| v2.0 | Chain of Thought 추가 | 적중률 37% |
| v3.0 | 시장 평가 40%로 상향 | 많은 오류 발생 |
| v3.1 | 프롬프트 간소화 (382자) | 적중률 42%, 오류 감소 |
| v4.0 | 선택 범위 확대 실험 | 대부분 오류 |
| v5.0 | 초단순화 | 적중률 47% |
| v6.0 | JSON 예시 추가 필수 발견 | 안정적 작동 |
| v7-8 | 복잡성 증가 실험 | 성능 저하 |
| v9.0 | 최종 최적화 | 적중률 44%, 오류 18% |

## 기술적 개선사항

### 1. 데이터 전처리
```python
# 기권/제외 말 필터링
if horse.get("win_odds", 999) == 0:
    print(f"  - {horse['chul_no']}번 {horse['hr_name']} 기권/제외 - 스킵")
    continue
```

### 2. Claude CLI 호출 최적화
- 타임아웃: 30초 → 30분 (1800초)
- 인코딩: UTF-8 명시
- JSON 파싱: 정규식으로 유연하게 처리

### 3. 평가 지표
- 부분 적중: 맞춘 말 당 33.33점
- 완전 적중: 100점 + 10점 보너스
- 신뢰도 추적: 예측별 confidence 기록

## 실무 적용 가이드

### 1. 프롬프트 작성 원칙
- **간결성**: 400자 이내
- **명확성**: 구체적인 숫자와 조건
- **예시 필수**: JSON 출력 예시 포함
- **유연성**: 경직된 규칙보다 범위 제공

### 2. 데이터 수집 시
- KRA API 4개 활용 (API12, API214, API299, API8_2)
- 기권말 사전 필터링
- 배당률 0 체크 필수

### 3. 운영 시 권장사항
- 매 경주 평가 후 피드백 수집
- 월 단위로 프롬프트 미세 조정
- 계절별/경마장별 특성 고려

## 향후 개선 방향

1. **단기 (1개월)**
   - 남은 18% Execution error 원인 파악
   - 경마장별 최적화 프롬프트 개발
   - 실시간 배당률 변화 반영

2. **중기 (3개월)**
   - 앙상블 전략 구현 (여러 프롬프트 조합)
   - 거리별/날씨별 세분화
   - 자동 프롬프트 튜닝 시스템

3. **장기 (6개월)**
   - 기계학습 모델과 하이브리드
   - 사용자별 맞춤 전략
   - 수익률 기반 최적화

## 결론

재귀 개선 프로세스를 통해 다음을 달성했습니다:

1. **성능 향상**: 평균 적중률 42% → 44%
2. **안정성 개선**: Execution error 50% → 18%
3. **핵심 발견**: JSON 예시의 중요성, 간결함의 가치
4. **최적 전략**: 1-2위 필수 + 3-5위 중 선택

가장 중요한 교훈은 **"복잡함보다 단순함이, 데이터보다 시장이 더 현명하다"**는 것입니다.